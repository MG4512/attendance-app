<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Tracker 2026</title>
  <!-- ✅ Correct Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; color: #2c3e50; }
    .container { display:none; max-width: 95%; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
    .login { text-align:center; margin-top:50px; }
    input, button, select { padding: 6px; margin: 4px; }
    .table-container { overflow-x:auto; margin-top:16px; border:1px solid #ccc; border-radius:6px; }
    table { border-collapse: collapse; width:max-content; min-width:100%; font-size:11px; }
    th, td { border:1px solid #ccc; padding:4px; text-align:center; white-space:nowrap; }
    th { background:#34495e; color:#fff; }
    .actions button { padding:4px 8px; }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div class="login" id="loginSection">
    <h2>Employee/Admin Login</h2>
    <input type="email" id="email" placeholder="Email" /><br/>
    <input type="password" id="password" placeholder="Password" /><br/>
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
  </div>

  <!-- App Container -->
  <div class="container">
    <h1>Attendance Tracker – Year 2026</h1>
    <button onclick="logout()">Logout</button>

    <!-- Employee View -->
    <div id="employeeView">
      <label for="monthSelect">Select Month:</label>
      <select id="monthSelect">
        <option value="0">January</option>
        <option value="1">February</option>
        <option value="2">March</option>
        <option value="3">April</option>
        <option value="4">May</option>
        <option value="5">June</option>
        <option value="6">July</option>
        <option value="7">August</option>
        <option value="8">September</option>
        <option value="9">October</option>
        <option value="10">November</option>
        <option value="11">December</option>
      </select>
      <h2 id="monthTitle"></h2>
      <div class="table-container">
        <table id="attendanceTable">
          <thead>
            <tr id="tableHeadRow"><th>Date</th><th>Status</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Admin View -->
    <div id="adminView" style="display:none;">
      <h2>Admin Dashboard – All Attendance</h2>
      <div class="table-container">
        <table id="adminTable">
          <thead>
            <tr><th>User ID</th><th>Date</th><th>Status</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCX_604u0liK0AaFcDt3dwy_EdXBLGXufk",
      authDomain: "attendance-tracker-348d3.firebaseapp.com",
      projectId: "attendance-tracker-348d3",
      storageBucket: "attendance-tracker-348d3.appspot.com",
      messagingSenderId: "34779168212",
      appId: "1:34779168212:web:2387945e87b19e51e86a41"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <!-- App Logic -->
  <script>
    const year = 2026;
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const daysInMonth = [31,28,31,30,31,30,31,31,30,31,30,31];
    if ((year % 4 === 0 && year % 100 !== 0) || year % 400 === 0) daysInMonth[1] = 29;

    let currentUID = null;

    function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      auth.signInWithEmailAndPassword(email, password)
        .then(user => {
          currentUID = user.user.uid;
          db.collection("users").doc(currentUID).get().then(doc => {
            const role = doc.exists ? doc.data().role : "employee";
            document.getElementById("loginSection").style.display = "none";
            document.querySelector(".container").style.display = "block";

            if (role === "admin") {
              document.getElementById("employeeView").style.display = "none";
              document.getElementById("adminView").style.display = "block";
              renderAdminView();
            } else {
              document.getElementById("employeeView").style.display = "block";
              document.getElementById("adminView").style.display = "none";
              renderMonth(parseInt(document.getElementById("monthSelect").value, 10));
            }
          });
        })
        .catch(err => alert("Login failed: " + err.message));
    }

    function signup() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!email.includes("@") || !email.includes(".")) {
        alert("Please enter a valid email address.");
        return;
      }
      if (password.length < 6) {
        alert("Password must be at least 6 characters long.");
        return;
      }

      auth.createUserWithEmailAndPassword(email, password)
        .then(user => {
          db.collection("users").doc(user.user.uid).set({
            email: email,
            role: "employee" // default role
          });
          alert("Account created! Please login.");
        })
        .catch(err => alert("Signup failed: " + err.message));
    }

    function logout() {
      auth.signOut()
        .then(() => {
          currentUID = null;
          document.querySelector(".container").style.display = "none";
          document.getElementById("loginSection").style.display = "block";
          alert("You have been logged out.");
        })
        .catch(err => alert("Logout failed: " + err.message));
    }

    function setAttendance(dayKey, value) {
      db.collection("attendance").doc(currentUID).set({
        [dayKey]: { status: value, timestamp: Date.now() }
      }, { merge: true });
    }

    function renderMonth(monthIndex) {
      document.getElementById("monthTitle").textContent = `${months[monthIndex]} ${year}`;
      const tableHeadRow = document.getElementById("tableHeadRow");
      tableHeadRow.innerHTML = "<th>Date</th><th>Status</th>";

      const tbody = document.querySelector("#attendanceTable tbody");
      tbody.innerHTML = "";

      db.collection("attendance").doc(currentUID).get().then(doc => {
        const data = doc.data() || {};
        for (let d = 1; d <= daysInMonth[monthIndex]; d++) {
          const dayKey = `${d}-${months[monthIndex]}-${year}`;
          const tr = document.createElement("tr");

          const dateCell = document.createElement("td");
          dateCell.textContent = dayKey;
          tr.appendChild(dateCell);

          const statusCell = document.createElement("td");
          const select = document.createElement("select");
          ["","Present","Absent","CL","SL","OL"].forEach(opt => {
            const option = document.createElement("option");
            option.value = opt;
            option.textContent = opt === "" ? "--" : opt;
            if (data[dayKey] && data[dayKey].status === opt) option.selected = true;
            select.appendChild(option);
          });

          if (data[dayKey] && (Date.now() - data[dayKey].timestamp > 24*60*60*1000)) {
            select.disabled = true;
            select.title = "Locked after 24 hours";
          } else {
            select.addEventListener("change", e => setAttendance(dayKey, e.target.value));
          }

          statusCell.appendChild(select);
          tr.appendChild(statusCell);
          tbody.appendChild(tr);
        }
      });
    }

    function renderAdminView() {
      const adminBody = document.querySelector("#adminTable tbody");
      adminBody.innerHTML = "";

      db.collection("attendance").get().then(snapshot => {
        snapshot.forEach(doc => {
          const userId = doc.id;
          const data = doc.data() || {};
          Object.keys(data).forEach(dayKey => {
            const status = data[dayKey]?.status || "";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${userId}</td>
              <td>${dayKey}</td>
              <td>${status}</td>
              <td class="actions">
                <button onclick="deleteAttendance('${userId}', '${dayKey}')">Delete</button>
              </td>
            `;
            adminBody.appendChild(tr);
          });
        });
      });
    }

    function deleteAttendance(userId, dayKey) {
      db.collection("attendance").doc(userId).update({
        [dayKey]: firebase.firestore.FieldValue.delete()
      }).then(() => {
        alert("Attendance deleted.");
        renderAdminView();
      }).catch(err => alert("Delete failed: " + err.message));
    }

    document.getElementById("monthSelect").addEventListener("change", () => {
      renderMonth(parseInt(document.getElementById("monthSelect").value, 10));
    });
  </script>
</body>
</html>
